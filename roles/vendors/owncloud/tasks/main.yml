---
- name: install packages
  include_tasks: 01-packages.yml

- name: check if owncloud configuration exist
  become: yes
  become_user: www-data
  become_method: sudo
  shell:
    chdir: "/var/www/owncloud/"
    cmd: ./occ maintenance:install --help 2>&1 | grep 'Usage:'
  failed_when: False
  register: occ_result

- name: set fact about owncloud configuration
  set_fact:
    owncloud_need_config: "{{ occ_result.rc == 0 }}"

- debug:
    msg: |
      'occ maintenance:install' is not available. It means ownCloud considers itself as installed.
      This playbook is not able to alter ownCloud configurations such as database, data directory and admin account.
      Previous setup has been keeped.
  when: not owncloud_need_config

- block:
    - name: setup database
      include_tasks: 02-database.yml

    - name: configure
      include_tasks: 03-configure.yml
  when: owncloud_need_config

- name: setup vhost
  include_tasks: 04-vhost.yml
